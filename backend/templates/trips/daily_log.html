{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{{ page_title|default:"Driver’s Daily Log — Preview" }}</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root {
        --ink: #111;
        --muted: #666;
        --line: #000;
        --tick: rgba(0, 0, 0, 0.85);
        --hour: rgba(0, 0, 0, 0.9);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: #fff;
        color: var(--ink);
        font-family: Arial, Helvetica, sans-serif;
      }
      @page {
        size: Letter;
        margin: 18pt 22pt;
      }

      .page {
        width: 816px;
        max-width: 100%;
        margin: 0 auto;
        padding: 10pt;
      }

      .head {
        border: 2px solid #000;
        padding: 10pt 12pt 6pt;
        position: relative;
      }
      .head-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10pt;
        align-items: end;
      }
      .title {
        text-align: center;
        font-weight: 700;
        font-size: 13.5pt;
        line-height: 1;
      }
      .subline {
        text-align: center;
        font-size: 8pt;
        margin-top: 2pt;
      }
      .small {
        font-size: 8pt;
        color: var(--muted);
      }
      .field {
        display: flex;
        flex-direction: column;
        gap: 4pt;
      }
      .line {
        min-height: 14pt;
        border-bottom: 1px solid #000;
      }
      .label {
        font-size: 8pt;
        color: var(--muted);
      }

      .timeline {
        border: 2px solid #000;
        border-top: 0;
        padding: 8pt 10pt 10pt;
      }
      .tl-head {
        display: grid;
        grid-template-columns: 80pt 1fr 70pt;
        align-items: end;
        gap: 6pt;
      }
      .tl-left {
        font-size: 9pt;
      }
      .tl-scale {
        position: relative;
        height: 22pt;
        border-left: 1px solid #000;
        border-right: 1px solid #000;
        background: #fff;
        color: #000;
      }
      .tl-right {
        font-size: 9pt;
        text-align: center;
      }
      .hour {
        position: absolute;
        top: 0;
        bottom: 0;
      }
      .h-txt {
        position: absolute;
        top: 2pt;
        left: 50%;
        transform: translateX(-50%);
        font-size: 7.5pt;
        background: #fff;
        color: #000;
        padding: 0 2px;
      }

      .lane {
        display: grid;
        grid-template-columns: 80pt 1fr 70pt;
        min-height: 36pt;
        border-bottom: 1px solid #000;
      }
      .lane:last-child {
        border-bottom: 0;
      }
      .lane-name {
        font-size: 9pt;
        display: flex;
        align-items: center;
      }
      .lane-total {
        font-size: 9pt;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .lane-track {
        position: relative;
        background: #fff;
        border-left: 1px solid #000;
        border-right: 1px solid #000;
        overflow: hidden;
      }

      .lane-track::before {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        height: 10px;
        background-image: repeating-linear-gradient(
          90deg,
          var(--tick) 0 1px,
          transparent 1px calc(100% / 96)
        );
        pointer-events: none;
      }
      .lane-track::after {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 10px;
        background-image: repeating-linear-gradient(
          90deg,
          var(--tick) 0 1px,
          transparent 1px calc(100% / 96)
        );
        pointer-events: none;
      }
      .lane-track .hour-posts {
        position: absolute;
        inset: 0;
        background-image: repeating-linear-gradient(
          90deg,
          var(--hour) 0 1.2px,
          transparent 1.2px calc(100% / 24)
        );
        opacity: 0.9;
        pointer-events: none;
      }

      .progress-svg {
        position: absolute;
        pointer-events: none;
      }
      .progress-path {
        stroke: #000;
        stroke-width: 2.25;
        fill: none;
        shape-rendering: crispEdges;
        stroke-linecap: square;
      }

      /* Remarks */
      .remarks {
        border-left: 2px solid #000;
        border-right: 2px solid #000;
        border-bottom: 2px solid #000;
        padding: 8pt 10pt;
      }
      .remarks-scale {
        position: relative;
        height: 20pt;
        border: 1px solid #000;
        border-top: 0;
        background: #fff;
        color: #000;
      }
      .remarks-box {
        border: 1px solid #000;
        border-top: 0;
        height: 140pt;
        padding: 8pt;
      }

      .foot {
        border: 2px solid #000;
        border-top: 0;
        padding: 8pt 10pt;
        display: grid;
        grid-template-columns: 1.3fr 1fr 1fr;
        gap: 10pt;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <!-- HEADER -->
      <div class="head">
        <div class="head-row">
          <div class="small">U.S. DEPARTMENT OF TRANSPORTATION</div>
          <div>
            <div class="title">DRIVER’S DAILY LOG</div>
            <div class="subline">(ONE CALENDAR DAY — 24 HOURS)</div>
          </div>
          <div class="small" style="text-align: right">
            ORIGINAL — Submit to carrier within 13 days<br />
            DUPLICATE — Driver retains possession for eight days
          </div>
        </div>

        <div class="head-row" style="margin-top: 10pt">
          <div class="field">
            <div class="line">{{ date_display }}</div>
            <div class="label">(MONTH) (DAY) (YEAR)</div>
          </div>
          <div class="field">
            <div class="line">{{ total_miles_driving_today }}</div>
            <div class="label">TOTAL MILES DRIVING TODAY</div>
          </div>
          <div class="field">
            <div class="line">{{ vehicle_numbers }}</div>
            <div class="label">VEHICLE NUMBERS — (SHOW EACH UNIT)</div>
          </div>
        </div>

        <div class="head-row" style="margin-top: 10pt">
          <div class="field">
            <div class="line">{{ carrier_name }}</div>
            <div class="label">NAME OF CARRIER(S)</div>
          </div>
          <div class="field">
            <div class="line">{{ main_office_address }}</div>
            <div class="label">MAIN OFFICE ADDRESS</div>
          </div>
          <div class="field">
            <div class="line">{{ driver_signature }}</div>
            <div class="label">
              DRIVER’S SIGNATURE (I certify entries are true and correct)
            </div>
          </div>
        </div>

        <div class="head-row" style="margin-top: 10pt">
          <div class="field">
            <div class="line">{{ co_driver_name }}</div>
            <div class="label">NAME OF CO-DRIVER</div>
          </div>
          <div class="field">
            <div class="line">{{ start_time_display }}</div>
            <div class="label">24-HOUR PERIOD STARTING TIME</div>
          </div>
          <div class="field">
            <div class="line">{{ total_hours_display }}</div>
            <div class="label">TOTAL HOURS</div>
          </div>
        </div>
      </div>

      <div class="timeline" id="tl">
        <div class="tl-head">
          <div class="tl-left">Midnight</div>
          <div id="tl-scale" class="tl-scale"></div>
          <div class="tl-right">Total Hours</div>
        </div>

        <div class="lane">
          <div class="lane-name">Off Duty</div>
          <div class="lane-track" data-lane="off">
            <div class="hour-posts"></div>
          </div>
          <div class="lane-total" id="tot-off">{{ total_off_duty }}</div>
        </div>
        <div class="lane">
          <div class="lane-name">Sleeper Berth</div>
          <div class="lane-track" data-lane="sb">
            <div class="hour-posts"></div>
          </div>
          <div class="lane-total" id="tot-sb">{{ total_sleeper }}</div>
        </div>
        <div class="lane">
          <div class="lane-name">Driving</div>
          <div class="lane-track" data-lane="driving">
            <div class="hour-posts"></div>
          </div>
          <div class="lane-total" id="tot-driving">{{ total_driving }}</div>
        </div>
        <div class="lane">
          <div class="lane-name">On Duty (Not Driving)</div>
          <div class="lane-track" data-lane="onduty">
            <div class="hour-posts"></div>
          </div>
          <div class="lane-total" id="tot-onduty">{{ total_onduty }}</div>
        </div>
      </div>

      <div class="remarks">
        <div id="remarks-scale" class="remarks-scale"></div>
        <div class="remarks-box">{{ remarks }}</div>
      </div>

      <div class="foot">
        <div class="field">
          <div class="line">{{ shipping_no }}</div>
          <div class="label">Pro or Shipping No.</div>
        </div>
        <div class="field">
          <div class="line">{{ shipper_name }}</div>
          <div class="label">Name of Shipper</div>
        </div>
        <div class="field">
          <div class="line">{{ commodity }}</div>
          <div class="label">Commodity</div>
        </div>
      </div>
    </div>

    <script>
      // Provide one day bucket from backend
      // Example: {"date":"2025-09-16","segments":[{"startIso":"...Z","endIso":"...Z","status":"DRIVING"}]}
      window.DAY_BUCKET = {{ day_bucket_json|default:"null"|safe }};

      /* Hour labels for top scale + remarks scale */
      (function buildScales() {
        const scale = document.getElementById("tl-scale");
        for (let h=0; h<=24; h++) {
          const el = document.createElement("div");
          el.className = "hour";
          el.style.left = `calc(${h}/24*100%)`;
          if (h<24) {
            const t = document.createElement("div");
            t.className = "h-txt";
            t.textContent = (h===0 ? "Midnight" : (h===12 ? "Noon" : (h % 12)));
            el.appendChild(t);
          }
          scale.appendChild(el);
        }
        const rscale = document.getElementById("remarks-scale");
        for (let h=0; h<=24; h++) {
          const el = document.createElement("div"); el.className = "hour";
          el.style.left = `calc(${h}/24*100%)`;
          rscale.appendChild(el);
        }
      })();


      const MAP = { OFF:"off", SB:"sb", DRIVING:"driving", ONDUTY:"onduty" };
      function parseIsoUTC(iso){ return new Date(iso.endsWith("Z") ? iso : iso.replace("+00:00","Z")); }
      function minsFromMidnightUTC(dt){
        const mid = new Date(Date.UTC(dt.getUTCFullYear(), dt.getUTCMonth(), dt.getUTCDate(), 0,0,0,0));
        return Math.max(0, Math.min(1440, Math.round((dt - mid) / 60000)));
      }
      function fmtHHMM(m){ const h=Math.floor(m/60), mm=m%60|0; return `${h}:${String(mm).padStart(2,"0")}`; }

      function totals(day){
        const t={off:0,sb:0,driving:0,onduty:0};
        (day?.segments||[]).forEach(s=>{
          const m=Math.max(0, Math.round((parseIsoUTC(s.endIso)-parseIsoUTC(s.startIso))/60000));
          t[MAP[s.status]||"off"] += m;
        });
        return t;
      }

      function changes(day){
        if(!day) return [];
        const segs=(day.segments||[])
          .map(s=>({start:parseIsoUTC(s.startIso), end:parseIsoUTC(s.endIso), lane:MAP[s.status]||"off"}))
          .sort((a,b)=>a.start-b.start);
        const out=[]; let initialLane="off";
        if (segs.length && minsFromMidnightUTC(segs[0].start)===0) initialLane=segs[0].lane;
        out.push({t:0, lane:initialLane});
        for(const s of segs){
          const ts=minsFromMidnightUTC(s.start), te=minsFromMidnightUTC(s.end);
          const last=out[out.length-1];
          if (ts>=0 && ts<=1440 && (last.t!==ts || last.lane!==s.lane)){ out.push({t:ts,lane:last.lane}); out.push({t:ts,lane:s.lane}); }
          if (te>=0 && te<=1440) out.push({t:te,lane:s.lane});
        }
        const last=out[out.length-1]; if(!last || last.t<1440) out.push({t:1440, lane:last?last.lane:initialLane});
        const d=[]; for(const p of out){ const prev=d[d.length-1]; if(!prev||prev.t!==p.t||prev.lane!==p.lane) d.push(p); } return d;
      }

      function draw(){
        const tl = document.getElementById("tl");
        const tracks = Array.from(tl.querySelectorAll(".lane-track"));
        if(!tracks.length) return;

        const left = tracks[0].offsetLeft, top = tracks[0].offsetTop;
        const width = tracks[0].clientWidth;
        const bottom = tracks[tracks.length-1].offsetTop + tracks[tracks.length-1].offsetHeight;
        const height = bottom - top;

        const old = tl.querySelector(".progress-svg"); if(old) old.remove();

        const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
        svg.setAttribute("class","progress-svg");
        svg.style.left = left+"px"; svg.style.top = top+"px";
        svg.style.width = width+"px"; svg.style.height = height+"px";
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
        tl.appendChild(svg);

        const laneY = {};
        tracks.forEach(tr => { laneY[tr.getAttribute("data-lane")] = tr.offsetTop - top + tr.clientHeight/2; });

        const xOf = (m)=> Math.max(0, Math.min(width, (m/1440)*width));
        const ch = changes(window.DAY_BUCKET);
        let d = "";
        if (ch.length){
          d += `M ${xOf(ch[0].t)} ${laneY[ch[0].lane]}`;
          for (let i=1;i<ch.length;i++){
            const c = ch[i];
            d += ` H ${xOf(c.t)}`;
            if (ch[i-1].lane !== c.lane) d += ` V ${laneY[c.lane]}`;
          }
        }

        const path = document.createElementNS("http://www.w3.org/2000/svg","path");
        path.setAttribute("class","progress-path");
        path.setAttribute("d", d);
        svg.appendChild(path);


        const t = totals(window.DAY_BUCKET);
        const set = (id,v)=>{ const el=document.getElementById(id); if(el && !el.textContent.trim()) el.textContent=v; };
        set("tot-off", fmtHHMM(t.off));
        set("tot-sb", fmtHHMM(t.sb));
        set("tot-driving", fmtHHMM(t.driving));
        set("tot-onduty", fmtHHMM(t.onduty));
      }

      window.addEventListener("load", draw);
      window.addEventListener("resize", ()=>{ clearTimeout(window.__r); window.__r=setTimeout(draw,150); });
    </script>
  </body>
</html>
